<?php
if (session_status() == PHP_SESSION_NONE) {
    session_start();
}

require_once 'Classes/db.php'; // conexão centralizada

if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $nome   = trim($_POST['nome'] ?? '');
    $email  = trim($_POST['email'] ?? '');
    $senha  = $_POST['senha'] ?? '';
    $confirmar_senha = $_POST['confirmar_senha'] ?? '';

    // Validação simples
    if ($senha !== $confirmar_senha) {
        $_SESSION['erro'] = "As senhas não conferem.";
        header("Location: cadastro.php");
        exit;
    }

    if (empty($nome) || empty($email) || empty($senha)) {
        $_SESSION['erro'] = "Preencha todos os campos.";
        header("Location: cadastro.php");
        exit;
    }

    try {
        // Verificar se já existe usuário com o mesmo e-mail
        $stmt = $pdo->prepare("SELECT id FROM usuarios WHERE email = :email");
        $stmt->execute([':email' => $email]);
        if ($stmt->fetch()) {
            $_SESSION['erro'] = "E-mail já cadastrado.";
            header("Location: cadastro.php");
            exit;
        }

        // Hash da senha
        $hash = password_hash($senha, PASSWORD_DEFAULT);

        // Inserir no banco
        $stmt = $pdo->prepare("INSERT INTO usuarios (nome, email, senha, tipo) VALUES (:nome, :email, :senha, :tipo)");
        $stmt->execute([
            ':nome'  => $nome,
            ':email' => $email,
            ':senha' => $hash,
            ':tipo'  => 'tecnico' // padrão, pode mudar se quiser
        ]);

        $_SESSION['sucesso'] = "Cadastro realizado com sucesso!";
        header("Location: inicial.html");
        exit;

    } catch (PDOException $e) {
        $_SESSION['erro'] = "Erro ao cadastrar: " . $e->getMessage();
        header("Location: cadastro.php");
        exit;
    }
}
?>

<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Login</title>
<link rel="stylesheet" href="inicial.css">
</head>
<body>

  <div class="container">
    <!-- Coluna esquerda: formulário -->
    <div class="formulario">
      <h2>Login</h2>
      <form action="inicial.html" method="post">
        <input type="email" name="email" placeholder="Digite seu e-mail" required>
        <input type="password" name="senha" placeholder="Digite sua senha" required>
        <button type="submit">Entrar</button>
      </form>
      <a href="cadastro.html">Cadastre-se aqui!</a>
    </div>

    <!-- Coluna direita: imagem -->
    <div class="imagem">
      <img src="imagens/nuvem.png" alt="Imagem lateral">
    </div>
  </div>

</body>
</html>
